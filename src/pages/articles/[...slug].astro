---
import RootLayout from '@/layouts/RootLayout.astro';
import { getArticles } from '@/lib/microcms';
import type { Article } from '@/lib/types';
import { marked, type Tokens } from 'marked';
import { markedHighlight } from 'marked-highlight';
import hljs from 'highlight.js';
import Breadcrumbs from '@/components/Breadcrumbs.astro';

// Configure marked with syntax highlighting
marked.use(
  markedHighlight({
    langPrefix: 'hljs language-',
    highlight(code, lang) {
      const language = hljs.getLanguage(lang) ? lang : 'plaintext';
      return hljs.highlight(code, { language }).value;
    },
  })
);

// Configure marked to handle links
marked.use({
  renderer: {
    link(token: Tokens.Link) {
      const { href, title, text } = token;
      const isExternal = href.startsWith('http://') || href.startsWith('https://');
      const target = isExternal ? ' target="_blank" rel="noopener noreferrer"' : '';
      const titleAttr = title ? ` title="${title}"` : '';
      return `<a href="${href}"${titleAttr}${target}>${text}</a>`;
    },
  },
});

export async function getStaticPaths() {
  try {
    const articles = await getArticles();
    return articles.map((article: Article) => ({
      params: { slug: article.permalink },
      props: { article },
    }));
  } catch (error) {
    console.error('Failed to fetch articles for static paths:', error);
    return [];
  }
}

interface Props {
  article: Article;
}

const { article } = Astro.props;

// Render markdown content to HTML
const content = marked.parse(article.content);

// Get description from content (first 100 characters)
// Remove markdown syntax characters (# * ` [ ]) before creating description
const description = article.content.replace(/[#*`\[\]]/g, '').substring(0, 100);
---

<RootLayout
  title={article.title}
  description={description}
  thumbnail={article.thumbnail?.url}
>
  <div
    class="page-hero"
    style={article.thumbnail?.url ? `background-image: url(${article.thumbnail.url});` : undefined}
  >
    <div class="page-container">
      <h1 class="page-title">{article.title}</h1>
    </div>
  </div>
  <!-- Add highlight.js CSS inline for syntax highlighting -->
  <style is:inline>
    @import url('https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css');
  </style>
  <div class="page-container">
    <div class="page-header">
      <Breadcrumbs items={[{ label: 'Home', href: '/' }, { label: 'News', href: '/articles/' }, { label: article.title }]} />
    </div>
    <main class="prose max-w-none mx-auto">
      {article.thumbnail && (
        <p>
          <img src={article.thumbnail.url} alt={article.title} />
        </p>
      )}
      <div set:html={content} />
    </main>
  </div>
</RootLayout>
